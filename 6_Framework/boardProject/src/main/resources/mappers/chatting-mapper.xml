<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chattingMapper">

<resultMap type="ChattingRoom" id="chattingRoom_rm">
      <id property="chattingNo" column="CHATTING_NO" />

      <result property="lastMessage" column="LAST_MESSAGE" />
      <result property="sendTime" column="SEND_TIME" />
      <result property="targetNo" column="TARGET_NO" />
      <result property="targetNickName" column="TARGET_NICKNAME" />
      <result property="targetProfile" column="TARGET_PROFILE" />
      <result property="notReadCount" column="NOT_READ_COUNT" />
   </resultMap>
   
   
    <select id="selectRoomList" resultMap="chattingRoom_rm">
    SELECT CHATTING_NO ,
	(SELECT MESSAGE_CONTENT FROM(
	SELECT *  FROM MESSAGE M
	WHERE M.CHATTING_NO =R.CHATTING_NO 
	ORDER BY MESSAGE_NO DESC)
	WHERE ROWNUM =1) LAST_MESSAGE,
	(SELECT TO_CHAR(MAX(SEND_TIME), 'YYYY.MM.DD') 
FROM MESSAGE M
WHERE M.CHATTING_NO = R.CHATTING_NO) SEND_TIME,
NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
			WHERE R2.CHATTING_NO = R.CHATTING_NO 
			AND OPEN_MEMBER =${memberNo}), 
			PARTICIPANT,
			OPEN_MEMBER) TARGET_NO,
	NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
			WHERE R2.CHATTING_NO = R.CHATTING_NO 
	AND OPEN_MEMBER =${memberNo}),
	(SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO=R.PARTICIPANT),
	(SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO=R.OPEN_MEMBER)) TARGET_NICKNAME,
	
	NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
			WHERE R2.CHATTING_NO = R.CHATTING_NO 
			AND OPEN_MEMBER =${memberNo}),
			(SELECT PROFILE_IMG FROM MEMBER WHERE MEMBER_NO=R.PARTICIPANT),
			(SELECT PROFILE_IMG FROM MEMBER WHERE MEMBER_NO=R.OPEN_MEMBER)) TARGET_PROFILE,
			
			(SELECT COUNT(*) FROM MESSAGE M
			WHERE READ_FL='N'
			AND M.CHATTING_NO =R.CHATTING_NO 
			AND SENDER_NO != ${memberNo}) NOT_READ_COUNT,
			
			(SELECT MAX(MESSAGE_NO) FROM MESSAGE M
			WHERE M.CHATTING_NO =R.CHATTING_NO) MAX_MESSAGE_NO
			
			
			
	FROM CHATTING_ROOM R
	WHERE OPEN_MEMBER=${memberNo}
	OR PARTICIPANT =${memberNo}
ORDER BY MAX_MESSAGE_NO DESC NULLS LAST
    
    </select>
</mapper>
